<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>قارئ الباركود - الجندي برو</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #2c7be5;
      --secondary-color: #00d97e;
      --danger-color: #e63757;
      --dark-color: #12263f;
      --light-color: #f9fafd;
    }
    
    body {
      font-family: 'Tajawal', Arial, sans-serif;
      text-align: center;
      padding: 0;
      margin: 0;
      background-color: var(--light-color);
      color: var(--dark-color);
    }
    
    .header {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 20px 0;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .logo {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .logo i {
      margin-left: 10px;
      color: var(--secondary-color);
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .scanner-section {
      background-color: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      margin: 20px 0;
    }
    
    #scanner-container {
      position: relative;
      margin: 20px auto;
      width: 100%;
      max-width: 400px;
      height: 300px;
      overflow: hidden;
      border-radius: 8px;
      border: 2px solid #e0e6ed;
    }
    
    #reader {
      width: 100%;
      height: 100%;
      position: relative;
    }
    
    .scan-line {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background-color: var(--danger-color);
      box-shadow: 0 0 10px var(--danger-color);
      animation: scan 2s linear infinite;
      z-index: 10;
    }
    
    @keyframes scan {
      0% { top: 0; }
      100% { top: 100%; }
    }
    
    .scan-frame {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 70%;
      height: 40%;
      border: 3px solid var(--primary-color);
      border-radius: 8px;
      z-index: 5;
    }
    
    .controls {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 10px 20px;
      border-radius: 6px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
    }
    
    .btn-primary {
      background-color: var(--primary-color);
      color: white;
    }
    
    .btn-secondary {
      background-color: var(--secondary-color);
      color: white;
    }
    
    .btn-danger {
      background-color: var(--danger-color);
      color: white;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .manual-search {
      background-color: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }
    
    .input-group {
      display: flex;
      max-width: 500px;
      margin: 0 auto;
    }
    
    #manualInput {
      flex: 1;
      padding: 12px 15px;
      border: 2px solid #e0e6ed;
      border-radius: 6px 0 0 6px;
      font-size: 16px;
      outline: none;
      transition: border 0.3s;
    }
    
    #manualInput:focus {
      border-color: var(--primary-color);
    }
    
    .search-btn {
      padding: 0 20px;
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 0 6px 6px 0;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.3s;
    }
    
    .search-btn:hover {
      background-color: #1c6bd6;
    }
    
    .status {
      margin-top: 20px;
      font-size: 14px;
      color: #6e84a3;
    }
    
    .powered-by {
      margin-top: 40px;
      font-size: 14px;
      color: #95aac9;
    }
    
    @media (max-width: 600px) {
      .container {
        padding: 10px;
      }
      
      .controls {
        flex-direction: column;
        align-items: center;
      }
      
      #scanner-container {
        height: 250px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="container">
      <div class="logo">
        <span>الجندي برو</span>
        <i class="fas fa-barcode"></i>
      </div>
      <h1>قارئ الباركود الذكي</h1>
    </div>
  </div>

  <div class="container">
    <div class="scanner-section">
      <h2>مسح الباركود</h2>
      <p>قومي بتوجيه الكاميرا نحو الباركود لمسحه تلقائياً</p>
      
      <div id="scanner-container">
        <div id="reader"></div>
        <div class="scan-line"></div>
        <div class="scan-frame"></div>
      </div>
      
      <div class="controls">
        <button class="btn btn-primary" onclick="toggleFlash()">
          <i class="fas fa-bolt"></i>
          <span id="flash-text">تشغيل الفلاش</span>
        </button>
        <button class="btn btn-secondary" onclick="switchCamera()">
          <i class="fas fa-camera-retro"></i>
          <span id="camera-text">الكاميرا الخلفية</span>
        </button>
        <button class="btn btn-danger" onclick="stopScanner()">
          <i class="fas fa-stop"></i>
          إيقاف الماسح
        </button>
      </div>
      
      <div class="status" id="status">
        جاهز للمسح...
      </div>
    </div>
    
    <div class="manual-search">
      <h3>أو ابحث يدوياً</h3>
      <div class="input-group">
        <input type="text" id="manualInput" placeholder="أدخل رقم الباركود هنا">
        <button class="search-btn" onclick="searchProduct()">
          <i class="fas fa-search"></i>
        </button>
      </div>
    </div>
    
    <div class="powered-by">
      نظام مسح الباركود - الجندي برو &copy; 2023
    </div>
  </div>

  <script>
    const elgendyBaseUrl = "https://elgendypro.com/ar/product/all/";
    let html5QrCode;
    let currentCameraId;
    let flashEnabled = false;
    let backCamera = false;
    let scannerActive = true;

    function onScanSuccess(decodedText) {
      updateStatus(`تم مسح الباركود: ${decodedText}`);
      setTimeout(() => {
        window.location.href = elgendyBaseUrl + decodedText;
      }, 1000);
    }

    function searchProduct() {
      const code = document.getElementById("manualInput").value.trim();
      if (code !== "") {
        updateStatus(`جاري البحث عن الباركود: ${code}`);
        setTimeout(() => {
          window.location.href = elgendyBaseUrl + code;
        }, 500);
      } else {
        updateStatus("الرجاء إدخال رقم الباركود", true);
      }
    }

    function toggleFlash() {
      if (!html5QrCode || !currentCameraId) return;
      
      flashEnabled = !flashEnabled;
      const flashBtn = document.querySelector('.btn-primary');
      const flashText = document.getElementById('flash-text');
      
      if (flashEnabled) {
        flashBtn.innerHTML = '<i class="fas fa-bolt"></i><span id="flash-text">إيقاف الفلاش</span>';
        updateStatus("تم تشغيل الفلاش");
      } else {
        flashBtn.innerHTML = '<i class="fas fa-bolt"></i><span id="flash-text">تشغيل الفلاش</span>';
        updateStatus("تم إيقاف الفلاش");
      }
      
      html5QrCode.applyVideoConstraints({
        advanced: [{torch: flashEnabled}]
      }).then(() => {
        console.log("تم تغيير حالة الفلاش");
      }).catch(err => {
        console.error("لا يدعم الفلاش", err);
        flashEnabled = false;
        flashText.textContent = "تشغيل الفلاش";
        updateStatus("هذا الجهاز لا يدعم الفلاش", true);
      });
    }

    function switchCamera() {
      backCamera = !backCamera;
      const cameraText = document.getElementById('camera-text');
      cameraText.textContent = backCamera ? "الكاميرا الأمامية" : "الكاميرا الخلفية";
      
      updateStatus(backCamera ? "جاري التبديل للكاميرا الخلفية" : "جاري التبديل للكاميرا الأمامية");
      
      stopScanner().then(() => {
        startScanner();
      });
    }

    function stopScanner() {
      if (!scannerActive) return Promise.resolve();
      
      scannerActive = false;
      updateStatus("تم إيقاف الماسح");
      return html5QrCode.stop().then(() => {
        console.log("تم إيقاف الماسح");
        document.querySelector('.scan-line').style.display = 'none';
      }).catch(err => {
        console.error("خطأ في إيقاف الماسح", err);
      });
    }

    function startScanner() {
      scannerActive = true;
      document.querySelector('.scan-line').style.display = 'block';
      
      Html5Qrcode.getCameras().then(devices => {
        if (devices && devices.length) {
          updateStatus("جاري تشغيل الماسح...");
          
          // تصفية الكاميرات حسب النوع
          const facingMode = backCamera ? "environment" : "user";
          const camera = devices.find(device => 
            device.label.toLowerCase().includes(facingMode) || 
            (backCamera && (device.label.includes("back") || device.label.includes("rear")) ||
            (!backCamera && device.label.includes("front"))
          );
          
          currentCameraId = camera ? camera.id : devices[0].id;
          
          const qrConfig = {
            fps: 10,
            qrbox: { width: 250, height: 250 },
            rememberLastUsedCamera: true,
            supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA]
          };
          
          html5QrCode.start(
            currentCameraId,
            qrConfig,
            onScanSuccess,
            () => updateStatus("جاري البحث عن باركود...")
          ).then(() => {
            updateStatus("جاهز للمسح");
          }).catch(err => {
            console.error("فشل تشغيل الكاميرا", err);
            updateStatus("فشل تشغيل الكاميرا", true);
          });
        } else {
          updateStatus("لا توجد كاميرا متاحة", true);
        }
      }).catch(err => {
        console.error("خطأ في الحصول على الكاميرات", err);
        updateStatus("خطأ في الوصول إلى الكاميرا", true);
      });
    }

    function updateStatus(message, isError = false) {
      const statusElement = document.getElementById('status');
      statusElement.textContent = message;
      statusElement.style.color = isError ? 'var(--danger-color)' : 'var(--primary-color)';
    }

    // تهيئة الماسح عند التحميل
    document.addEventListener('DOMContentLoaded', function() {
      html5QrCode = new Html5Qrcode("reader");
      startScanner();
      
      // تفعيل البحث عند الضغط على Enter
      document.getElementById('manualInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          searchProduct();
        }
      });
    });
  </script>
</body>
</html>
