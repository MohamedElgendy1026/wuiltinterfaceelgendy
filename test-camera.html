<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ูุงุฑุฆ ุงูุจุงุฑููุฏ - ุนุฑุถ ุงูููุชุฌ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* ... ููุง ูุชููู ููุณ CSS ุจุชุงุนู ุจุงููุงูู ... */
        /* ุฃูุง ูุด ูุนูุฏู ุชุงูู ูุฅูู ูุชุจุชู ูุงูู ููู ููุงููููุด ุฃู ูุดููุฉุ ุจุณ ูู ุนุงูุฒ ุฃุฎุชุตุฑู ูู ุฃู ุฃุนุฏูู ูููู */
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ูุงุฑุฆ ุงูุจุงุฑููุฏ - ุนุฑุถ ุงูููุชุฌ</h1>
            <p>ุงูุณุญ ุจุงุฑููุฏ ุงูููุชุฌ ูุนุฑุถ ุชูุงุตููู</p>
        </div>

        <div class="scanner-container">
            <div id="reader"></div>
            <div class="scan-overlay">
                <div class="scan-box">
                    <div class="scan-line"></div>
                </div>
            </div>
        </div>

        <div class="controls">
            <button onclick="restartScanner()" class="btn-warning">โป๏ธ ุฅุนุงุฏุฉ ุงูุชุดุบูู</button>
        </div>

        <div id="status" class="status status-loading">โณ ุฌุงุฑู ุชููุฆุฉ ูุงุฑุฆ ุงูุจุงุฑููุฏ...</div>

        <div class="manual-section">
            <h3>ุงูุฅุฏุฎุงู ุงููุฏูู</h3>
            <input type="text" id="manualInput" placeholder="ุฃุฏุฎู ุฑูู ุงูุจุงุฑููุฏ ููุง...">
            <button onclick="manualSearch()" class="btn-success" style="width:100%;">๐ ุจุญุซ ุนู ุงูููุชุฌ</button>
        </div>

        <div id="result" class="result-container" style="display:none;">
            <h3>ุชูุงุตูู ุงูููุชุฌ</h3>
            <div id="resultContent"></div>
        </div>
    </div>

    <script>
        // ุงููุชุบูุฑุงุช
        const statusEl = document.getElementById('status');
        const resultEl = document.getElementById('result');
        const resultContent = document.getElementById('resultContent');
        const manualInput = document.getElementById('manualInput');
        
        let html5QrScanner;
        let lastResult = '';
        let isScanning = false;

        async function initScanner() {
            try {
                setStatus('loading', 'โณ ุฌุงุฑู ุงูุชุญุถูุฑ...');
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('ุงููุชุตูุญ ูุง ูุฏุนู ุงููุตูู ุฅูู ุงููุงููุฑุง');
                }

                html5QrScanner = new Html5Qrcode("reader");
                const config = {
                    fps: 15,
                    qrbox: { width: 250, height: 250 },
                    formatsToSupport: [
                        Html5QrcodeSupportedFormats.UPC_A,
                        Html5QrcodeSupportedFormats.EAN_13,
                        Html5QrcodeSupportedFormats.CODE_128
                    ]
                };

                await html5QrScanner.start({ facingMode: "environment" }, config, onScanSuccess, onScanError);
                isScanning = true;
                setStatus('ready', 'โ ุฌุงูุฒ ูููุณุญ - ูุฑุจ ุงูุจุงุฑููุฏ ูู ุงููุงููุฑุง');
            } catch (error) {
                handleInitError(error);
            }
        }

        function onScanSuccess(decodedText) {
            if (decodedText !== lastResult) {
                lastResult = decodedText;
                playBeep();
                searchProduct(decodedText);
                setStatus('ready', 'โ ุชู ุงูุนุซูุฑ ุนูู ููุชุฌ!');
                setTimeout(() => {
                    if (html5QrScanner && isScanning) {
                        html5QrScanner.pause();
                        setStatus('ready', 'โธ ุชู ุงูุฅููุงู ุงููุคูุช');
                    }
                }, 1000);
            }
        }

        function onScanError(error) {
            if (!error.includes('NotFoundException')) {
                console.warn('ุชุญุฐูุฑ ุงููุณุญ:', error);
            }
        }

        async function restartScanner() {
            try {
                if (html5QrScanner && isScanning) {
                    await html5QrScanner.stop();
                }
                await initScanner();
            } catch (error) {
                console.error('ุฎุทุฃ ูู ุฅุนุงุฏุฉ ุงูุชุดุบูู:', error);
            }
        }

        function manualSearch() {
            const code = manualInput.value.trim();
            if (code) {
                searchProduct(code);
            } else {
                showAlert('โ ุงูุฑุฌุงุก ุฅุฏุฎุงู ุงูุจุงุฑููุฏ ุฃููุงู');
            }
        }

        async function searchProduct(barcode) {
            try {
                resultContent.innerHTML = '<div class="loading-spinner"></div><p>ุฌุงุฑู ุงูุจุญุซ ุนู ุงูููุชุฌ...</p>';
                resultEl.style.display = 'block';

                const response = await fetch(`https://www.elgendypro.com/api/products?barcode=${encodeURIComponent(barcode)}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) throw new Error('ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูููุชุฌ');

                const product = await response.json();
                if (product && product.id) {
                    displayProduct(product);
                } else {
                    showProductNotFound(barcode);
                }
            } catch (error) {
                console.error('ุฎุทุฃ ูู ุงูุจุญุซ ุนู ุงูููุชุฌ:', error);
                resultContent.innerHTML = `
                    <div class="alert alert-warning">
                        <p>โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุจุญุซ ุนู ุงูููุชุฌ</p>
                        <p>${error.message || 'ุงูุฑุฌุงุก ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู ูุงุญููุง'}</p>
                    </div>`;
            }
        }

        function displayProduct(product) {
            resultContent.innerHTML = `
                ${product.image ? `<img src="${product.image}" class="product-image">` : ''}
                <h3 class="product-title">${product.name}</h3>
                ${product.price ? `<p class="product-price">ุงูุณุนุฑ: ${product.price} ุฌููู</p>` : ''}
                ${product.stock ? `<p>ุงููููุฉ ุงููุชุงุญุฉ: <span class="product-stock">${product.stock}</span></p>` : ''}
                ${product.description ? `<p><strong>ุงููุตู:</strong></p><div style="background:#f8f9fa; padding:10px; border-radius:5px;">${product.description}</div>` : ''}
                ${product.link ? `<p style="text-align:center; margin-top:15px;"><a href="${product.link}" target="_blank" style="color: var(--main-color);">ุนุฑุถ ุงููุฒูุฏ ูู ุงูุชูุงุตูู</a></p>` : ''}
            `;
            manualInput.value = product.barcode || lastResult;
        }

        function showProductNotFound(barcode) {
            resultContent.innerHTML = `
                <div class="alert alert-warning">
                    <p>โ ูู ูุชู ุงูุนุซูุฑ ุนูู ููุชุฌ ูุทุงุจู ููุจุงุฑููุฏ: <strong>${barcode}</strong></p>
                    <p>ุงูุฑุฌุงุก ุงูุชุฃูุฏ ูู ุตุญุฉ ุงูุจุงุฑููุฏ</p>
                </div>`;
        }

        function setStatus(type, message) {
            statusEl.className = `status status-${type}`;
            statusEl.innerHTML = message;
        }

        function showAlert(message) {
            const alertDiv = document.createElement('div');
            alertDiv.style.position = 'fixed';
            alertDiv.style.bottom = '20px';
            alertDiv.style.left = '50%';
            alertDiv.style.transform = 'translateX(-50%)';
            alertDiv.style.backgroundColor = '#333';
            alertDiv.style.color = 'white';
            alertDiv.style.padding = '10px 20px';
            alertDiv.style.borderRadius = '5px';
            alertDiv.style.zIndex = '1000';
            alertDiv.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 3000);
        }

        function playBeep() {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.type = 'sine';
                osc.frequency.value = 800;
                gain.gain.value = 0.3;
                osc.start();
                setTimeout(() => osc.stop(), 200);
            } catch (e) {
                console.log('ุชุนุฐุฑ ุชุดุบูู ุงูุตูุช:', e);
            }
        }

        function handleInitError(error) {
            console.error('ุฎุทุฃ ุงูุชููุฆุฉ:', error);
            setStatus('error', `โ ${getErrorMessage(error)}`);
            enableManualInput();
        }

        function getErrorMessage(error) {
            const map = {
                'NotAllowedError': 'ุชู ุฑูุถ ุงูุฅุฐู ุจุงููุตูู ุฅูู ุงููุงููุฑุง',
                'NotFoundError': 'ูู ูุชู ุงูุนุซูุฑ ุนูู ูุงููุฑุง',
                'NotSupportedError': 'ุงููุชุตูุญ ูุง ูุฏุนู ูุฐู ุงูููุฒุฉ',
                'NotReadableError': 'ุงููุงููุฑุง ููุฏ ุงูุงุณุชุฎุฏุงู',
                'OverconstrainedError': 'ูุง ุชูุฌุฏ ูุงููุฑุง ูุชูุงููุฉ'
            };
            return map[error.name] || error.message || 'ุญุฏุซ ุฎุทุฃ ุบูุฑ ูุชููุน';
        }

        function enableManualInput() {
            manualInput.disabled = false;
            manualInput.placeholder = 'ุงุณุชุฎุฏู ุงูุฅุฏุฎุงู ุงููุฏูู ุจุณุจุจ ูุดููุฉ ุงููุงููุฑุง';
        }

        // ุจุฏุก ุงูุชููุฆุฉ ููุง ุงูุตูุญุฉ ุชูุชุญ
        window.addEventListener('load', initScanner);
    </script>
</body>
</html>

