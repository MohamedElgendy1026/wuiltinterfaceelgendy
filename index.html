<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ูุงุฑุฆ ุงูุจุงุฑููุฏ ุงููุชูุฏู</title>
    <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@latest/dist/html5-qrcode.min.js"></script>
    <style>
        /* ... (ููุณ ุงูุฃููุงุท ุงูุณุงุจูุฉ) ... */
    </style>
</head>
<body>
    <div class="container">
        <!-- ... (ููุณ ุงููููู ุงูุณุงุจู) ... -->
    </div>

    <script>
        // ... (ุงููุชุบูุฑุงุช ุงูุณุงุจูุฉ) ...

        async function startScanner(cameraId) {
            try {
                setStatus('loading', '๐ท ุฌุงุฑู ุชุดุบูู ุงููุงููุฑุง...');
                
                if (html5QrScanner && html5QrScanner.isScanning) {
                    await html5QrScanner.stop();
                }

                html5QrScanner = new Html5Qrcode("reader");
                
                // ุฅุนุฏุงุฏุงุช ูุญุณูุฉ ูููุณุญ
                const config = {
                    fps: 20,  // ุฒูุงุฏุฉ ูุนุฏู ุงูุฅุทุงุฑุงุช
                    qrbox: {
                        width: 250,
                        height: 250
                    },
                    rememberLastUsedCamera: true,
                    supportedScanTypes: [
                        Html5QrcodeScanType.SCAN_TYPE_CAMERA,
                        Html5QrcodeScanType.SCAN_TYPE_FILE
                    ],
                    formatsToSupport: [
                        Html5QrcodeSupportedFormats.UPC_A,
                        Html5QrcodeSupportedFormats.UPC_E,
                        Html5QrcodeSupportedFormats.EAN_13,
                        Html5QrcodeSupportedFormats.EAN_8,
                        Html5QrcodeSupportedFormats.CODE_128,
                        Html5QrcodeSupportedFormats.CODE_39,
                        Html5QrcodeSupportedFormats.CODE_93,
                        Html5QrcodeSupportedFormats.QR_CODE
                    ]
                };

                await html5QrScanner.start(
                    cameraId, 
                    config,
                    qrCodeMessage => {
                        if (qrCodeMessage !== lastResult) {
                            lastResult = qrCodeMessage;
                            handleSuccessfulScan(qrCodeMessage);
                        }
                    },
                    qrCodeError => {
                        // ุชุฌุงูู ุงูุฃุฎุทุงุก ุงูุฑูุชูููุฉ
                        if (!qrCodeError.message.includes("NotFoundException")) {
                            console.warn("ุฎุทุฃ ุงููุณุญ:", qrCodeError);
                        }
                    }
                );

                // ... (ุจุงูู ุงูููุฏ ุงูุณุงุจู) ...

            } catch (error) {
                console.error('ุฎุทุฃ ุจุฏุก ุงููุงุณุญ:', error);
                setStatus('error', `โ ${getEnhancedErrorMessage(error)}`);
                enableManualInput();
            }
        }

        function handleSuccessfulScan(decodedText) {
            beep();
            resultEl.innerHTML = `
                <strong>โ ุชู ูุฑุงุกุฉ ุงูุจุงุฑููุฏ ุจูุฌุงุญ:</strong><br>
                <div style="word-wrap:break-word;">${decodedText}</div><br>
                <button onclick="openResult('${encodeURIComponent(decodedText)}')">
                    ุนุฑุถ ุงููุชุงุฆุฌ
                </button>
            `;
            setStatus('ready', 'โ ุชู ุงููุณุญ ุจูุฌุงุญ!');
            
            // ุฅููุงู ูุคูุช ูููุงุณุญ ุจุนุฏ ุงููุฑุงุกุฉ ุงููุงุฌุญุฉ
            setTimeout(() => {
                if (html5QrScanner && html5QrScanner.isScanning) {
                    html5QrScanner.pause();
                    setStatus('ready', 'โธ ุงููุงุณุญ ูุชููู - ุงููุฑ ุฅุนุงุฏุฉ ุงูุชุดุบูู ูููุณุญ ูุฌุฏุฏุงู');
                }
            }, 1000);
        }

        function getEnhancedErrorMessage(error) {
            const errorMap = {
                'NotAllowedError': 'ุชู ุฑูุถ ุงูุฅุฐู ุจุงุณุชุฎุฏุงู ุงููุงููุฑุง',
                'NotFoundError': 'ูู ูุชู ุงูุนุซูุฑ ุนูู ูุงููุฑุง ูุชูุงููุฉ',
                'NotSupportedError': 'ุงููุชุตูุญ ูุง ูุฏุนู ูุฐู ุงูููุฒุฉ',
                'NotReadableError': 'ุงููุงููุฑุง ููุฏ ุงูุงุณุชุฎุฏุงู ูู ูุจู ุชุทุจูู ุขุฎุฑ',
                'OverconstrainedError': 'ูุง ุชูุฌุฏ ูุงููุฑุง ูุชูุงููุฉ ูุน ุงููุชุทูุจุงุช',
                'StreamApiNotSupportedError': 'ุงููุชุตูุญ ูุง ูุฏุนู ูุงุฌูุฉ Stream API'
            };
            
            return errorMap[error.name] || 
                   error.message || 
                   'ุญุฏุซ ุฎุทุฃ ุบูุฑ ูุชููุน ูู ุชุดุบูู ุงููุงููุฑุง';
        }

        // ... (ุจุงูู ุงูุฏูุงู ุงูุณุงุจูุฉ) ...

        // ุจุฏุก ุงูุชุดุบูู ูุน ุชุญููู ุงูุตูุญุฉ
        document.addEventListener('DOMContentLoaded', () => {
            // ุชุฃุฎูุฑ ุจุณูุท ูุถูุงู ุชุญููู DOM ุจุงููุงูู
            setTimeout(async () => {
                await initScanner();
                
                // ุงุฎุชุจุงุฑ ุชููุงุฆู ุฅุฐุง ูุงู ูู ูุถุน ุงูุชุทููุฑ
                if (window.location.href.includes('localhost')) {
                    runTestScan();
                }
            }, 300);
        });

        // ูุธููุฉ ูุงุฎุชุจุงุฑ ุงููุณุญ (ููุชุทููุฑ ููุท)
        function runTestScan() {
            console.log("ูุถุน ุงูุงุฎุชุจุงุฑ: ุฌุงุฑู ูุญุงูุงุฉ ูุณุญ ุจุงุฑููุฏ...");
            setTimeout(() => {
                handleSuccessfulScan("TEST1234567890");
            }, 3000);
        }
    </script>
</body>
</html>
