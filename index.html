<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Ø³ÙƒØ§Ù† Ø¨Ø§Ø±ÙƒÙˆØ¯ | Ø§Ù„Ø¬Ù†Ø¯ÙŠ Ø¨Ø±Ùˆ</title>
  <script src="https://unpkg.com/html5-qrcode@2.3.9/html5-qrcode.min.js"></script>
  <style>
    body {
      font-family: Arial;
      text-align: center;
      background: #f0f0f0;
      direction: rtl;
      padding: 20px;
    }

    #reader {
      width: 100%;
      max-width: 500px;
      margin: 0 auto;
      position: relative;
      border: 3px solid #ddd;
      border-radius: 10px;
      overflow: hidden;
    }

    #reader video {
      width: 100%;
    }

    .laser {
      position: absolute;
      top: 10%;
      left: 5%;
      width: 90%;
      height: 2px;
      background: rgba(255, 0, 0, 0.7);
      animation: scan 2s infinite;
      z-index: 5;
      box-shadow: 0 0 10px red;
    }

    @keyframes scan {
      0% { top: 10%; }
      50% { top: 90%; }
      100% { top: 10%; }
    }

    .controls {
      margin: 20px auto;
      max-width: 500px;
    }

    input {
      margin-top: 20px;
      padding: 12px;
      font-size: 16px;
      width: 100%;
      max-width: 400px;
      border: 2px solid #ddd;
      border-radius: 5px;
    }

    button {
      padding: 12px 20px;
      font-size: 16px;
      margin: 10px 5px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #45a049;
    }

    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }

    #status {
      margin: 15px auto;
      font-weight: bold;
      padding: 10px;
      border-radius: 5px;
      max-width: 500px;
    }

    .loading {
      color: #007bff;
    }

    .success {
      color: #28a745;
      background-color: #e8f5e9;
    }

    .error {
      color: #dc3545;
      background-color: #f8d7da;
    }

    #cameraSelect {
      margin: 10px 0;
      padding: 10px;
      width: 100%;
      max-width: 400px;
    }

    .scanner-container {
      position: relative;
    }
  </style>
</head>
<body>
  <h2>Ø§Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø£Ùˆ Ø§ÙƒØªØ¨Ù‡ ÙŠØ¯ÙˆÙŠÙ‹Ø§</h2>

  <div class="scanner-container">
    <div id="reader">
      <div class="laser"></div>
    </div>
    <select id="cameraSelect" style="display:none;"></select>
  </div>

  <div class="controls">
    <button onclick="toggleFlash()">ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙÙ„Ø§Ø´ ğŸ”¦</button>
    <button onclick="switchCamera()">ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ğŸ”„</button>
    <button onclick="restartScanner()">Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø§Ø³Ø­ â™»ï¸</button>
  </div>

  <div id="status" class="loading">ğŸ“· Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø§Ø³Ø­...</div>

  <input type="text" id="manualInput" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙŠØ¯ÙˆÙŠÙ‹Ø§">
  <br>
  <button onclick="manualSearch()">Ø¨Ø­Ø« ÙŠØ¯ÙˆÙŠ ğŸ”</button>

  <audio id="beep" src="https://www.soundjay.com/buttons/sounds/beep-07.mp3" preload="auto"></audio>

  <script>
    const beep = document.getElementById('beep');
    const status = document.getElementById('status');
    const cameraSelect = document.getElementById('cameraSelect');
    let html5QrScanner;
    let currentTrack;
    let cameras = [];
    let currentCameraIndex = 0;
    let isScanning = false;

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø§Ø³Ø­ Ø§Ù„Ø¶ÙˆØ¦ÙŠ
    function initScanner(cameraId) {
      if (html5QrScanner && isScanning) {
        html5QrScanner.stop().then(() => {
          startScanner(cameraId);
        }).catch(err => {
          console.error("Error stopping scanner:", err);
          startScanner(cameraId);
        });
      } else {
        startScanner(cameraId);
      }
    }

    function startScanner(cameraId) {
      status.textContent = "ğŸ“· Ø¬Ø§Ø±ÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§...";
      status.className = "loading";
      
      html5QrScanner = new Html5Qrcode("reader");
      html5QrScanner.start(
        cameraId,
        {
          fps: 15,
          qrbox: { width: 250, height: 250 },
          aspectRatio: 1.0,
          disableFlip: false
        },
        onScanSuccess,
        onScanError
      ).then(() => {
        isScanning = true;
        status.textContent = "ğŸ“· Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¬Ø§Ù‡Ø²Ø©ØŒ Ø§Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯...";
        status.className = "success";
        
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø³Ø§Ø± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ÙÙ„Ø§Ø´
        const stream = document.querySelector("video").srcObject;
        if (stream) {
          currentTrack = stream.getVideoTracks()[0];
        }
      }).catch(err => {
        console.error("Error starting scanner:", err);
        status.textContent = "âŒ ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: " + err.message;
        status.className = "error";
        isScanning = false;
      });
    }

    function onScanSuccess(decodedText, decodedResult) {
      beep.play();
      status.textContent = `âœ… ØªÙ… Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯: ${decodedText}`;
      status.className = "success";
      
      // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø§Ø³Ø­ Ù‚Ø¨Ù„ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù„Ù„Ù†ØªØ§Ø¦Ø¬
      if (html5QrScanner && isScanning) {
        html5QrScanner.stop().then(() => {
          isScanning = false;
          window.location.href = `https://www.elgendypro.com/search?query=${encodeURIComponent(decodedText)}`;
        }).catch(err => {
          console.error("Error stopping scanner:", err);
          window.location.href = `https://www.elgendypro.com/search?query=${encodeURIComponent(decodedText)}`;
        });
      } else {
        window.location.href = `https://www.elgendypro.com/search?query=${encodeURIComponent(decodedText)}`;
      }
    }

    function onScanError(errorMessage) {
      // Ù„Ø§ Ù†Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø¨Ø§Ø³ØªÙ…Ø±Ø§Ø± Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªØ´ØªÙŠØª
      if (!status.textContent.includes("Ø¬Ø§Ù‡Ø²Ø©")) {
        status.textContent = `âŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø³Ø­...`;
        status.className = "error";
      }
    }

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©
    function getCameras() {
      Html5Qrcode.getCameras().then(devices => {
        if (devices && devices.length) {
          cameras = devices;
          
          // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø£ÙƒØ«Ø± Ù…Ù† ÙƒØ§Ù…ÙŠØ±Ø§ØŒ Ù†Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
          if (cameras.length > 1) {
            cameraSelect.style.display = "block";
            cameraSelect.innerHTML = "";
            cameras.forEach((camera, index) => {
              const option = document.createElement("option");
              option.value = camera.id;
              option.text = camera.label || `Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ${index + 1}`;
              if (index === currentCameraIndex) {
                option.selected = true;
              }
              cameraSelect.appendChild(option);
            });
          }
          
          // Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø§Ø³Ø­ Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø£ÙˆÙ„Ù‰
          initScanner(cameras[currentCameraIndex].id);
        } else {
          status.textContent = "âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØ§Ù…ÙŠØ±Ø§Øª Ù…ØªØ§Ø­Ø©";
          status.className = "error";
        }
      }).catch(err => {
        console.error("Error getting cameras:", err);
        status.textContent = "âŒ ØªØ¹Ø°Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Øª";
        status.className = "error";
      });
    }

    // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
    function switchCamera() {
      if (cameras.length < 2) {
        alert("âš ï¸ ÙŠÙˆØ¬Ø¯ ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· Ù…ØªØ§Ø­Ø©");
        return;
      }
      
      currentCameraIndex = (currentCameraIndex + 1) % cameras.length;
      initScanner(cameras[currentCameraIndex].id);
      
      if (cameraSelect) {
        cameraSelect.selectedIndex = currentCameraIndex;
      }
    }

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø§Ø³Ø­
    function restartScanner() {
      if (cameras.length > 0) {
        initScanner(cameras[currentCameraIndex].id);
      } else {
        getCameras();
      }
    }

    // Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ÙÙ„Ø§Ø´
    function toggleFlash() {
      if (currentTrack) {
        const capabilities = currentTrack.getCapabilities();
        if (capabilities.torch) {
          const current = currentTrack.getSettings().torch || false;
          currentTrack.applyConstraints({
            advanced: [{ torch: !current }]
          }).then(() => {
            console.log("Flash toggled:", !current);
          }).catch(err => {
            console.error("Error toggling flash:", err);
            alert("âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ÙÙ„Ø§Ø´");
          });
        } else {
          alert("âš ï¸ Ø§Ù„Ø¬Ù‡Ø§Ø² Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙ„Ø§Ø´");
        }
      } else {
        alert("ğŸ“· Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø© Ø¨Ø¹Ø¯ Ø£Ùˆ Ù„Ø§ ØªØ¯Ø¹Ù… Ø§Ù„ÙÙ„Ø§Ø´");
      }
    }

    // Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ÙŠØ¯ÙˆÙŠ
    function manualSearch() {
      const input = document.getElementById('manualInput').value.trim();
      if (input) {
        window.location.href = `https://www.elgendypro.com/search?query=${encodeURIComponent(input)}`;
      } else {
        alert("â— Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø£ÙˆÙ„Ø§Ù‹");
      }
    }

    // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter
    document.getElementById('manualInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        manualSearch();
      }
    });

    // ØªØºÙŠÙŠØ± Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
    cameraSelect.addEventListener('change', function() {
      currentCameraIndex = this.selectedIndex;
      initScanner(cameras[currentCameraIndex].id);
    });

    // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    window.onload = function() {
      getCameras();
    };
  </script>
</body>
</html>
